<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 服务器获取浏览器用户真实IP · Doublekai的博客</title><meta name="description" content="服务器获取浏览器用户真实IP - DOUBLEKAI"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/touxiang.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.doublekai.com/atom.xml" title="Doublekai的博客"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Doublekai的博客" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/touxiang.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/doublekai" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://www.cnblogs.com/doublekai/" target="_blank" class="nav-list-link">BLOG GARDEN</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">服务器获取浏览器用户真实IP</h1><div class="post-info">Aug 17, 2021</div><div class="post-content"><h5 id="nginx-配置文件中获取源IP的配置项"><a href="#nginx-配置文件中获取源IP的配置项" class="headerlink" title="nginx 配置文件中获取源IP的配置项"></a>nginx 配置文件中获取源IP的配置项</h5><p>proxy_set_header Host $host;<br>proxy_set_header X-Real-IP $remote_addr; #一般的web服务器用这个 X-Real-IP 来获取源IP<br>proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for; #如果nginx 服务器是作为反向代理服务器的，则这个配置项是必须的；否则看不到源IP</p>
<h5 id="nginx-代理服务器的模块"><a href="#nginx-代理服务器的模块" class="headerlink" title="nginx 代理服务器的模块"></a>nginx 代理服务器的模块</h5><p>nginx 通过 ngx_http_proxy_module模块 实现反向代理；在nginx 启动服务load conf时，<br> 就会读取 proxy_set_header 的配置项；来获取需要的变量。proxy_set_header 是用来设置请求的header的；<br> 比如：设置上面的host  X-Real-IP x-forwarded-for </p>
<h5 id="3个配置项的含义"><a href="#3个配置项的含义" class="headerlink" title="3个配置项的含义"></a>3个配置项的含义</h5><p>host：只要 用户在浏览器中访问的域名绑定了 VIP VIP 下面有RS；则就用$host ；host是访问URL 中的域名和端口  <a target="_blank" rel="noopener" href="http://www.taobao.com/">www.taobao.com:80</a><br>X-real-IP:把源IP 【$remote_addr,建立HTTP连接header里面的信息】赋值给X-Real-IP;</p>
<p>####环境：nginx做反向代理，apache做后端服务器<br>nginx部分配置代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream apache&#123;</span><br><span class="line">server 127.0.0.1:8080; # 后端真实服务器地址及端口</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line"></span><br><span class="line">server_name www.a.com;</span><br><span class="line">root /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http://apache;</span><br><span class="line">proxy_set_header ClientIpGetFromNginx $remote_addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>变量 $remote_addr 代表客户端ip地址<br>nginx反向代理会添加一个请求头<br>proxy_set_header X-Forwarded-For $remote_addr;<br>以此传递客户端ip到后端服务器。<br>此时去查看后端服务器的访问日志如下<br>127.0.0.1 – – [01/Sep/2017:10:31:10 +0800] 后面内容省略···<br>可以看出来访问返回的是nginx也就是Referer上一层的ip，需要在apache日志格式修改<br>LogFormat “%{ClientIpGetFromNginx}i %l %u %t \”%r\” %&gt;s %b \”%{Referer}i\” \”%{User-Agent}i\”” combined</p>
<h3 id="如何判断移动端浏览器发出的请求并重定向站点"><a href="#如何判断移动端浏览器发出的请求并重定向站点" class="headerlink" title="如何判断移动端浏览器发出的请求并重定向站点"></a>如何判断移动端浏览器发出的请求并重定向站点</h3><p>1、移动端开发需要加入的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=UTF-8&quot;&gt;  </span><br><span class="line">&lt;meta name=&quot;viewport&quot; content=&quot;initial-scale=1,  user-scalable=no&quot;,</span><br><span class="line"></span><br><span class="line">maximum-scale=1, minimum-scale=1&gt;</span><br></pre></td></tr></table></figure>

<p>2、判断移动端还是PC端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function browserRedirect() &#123;</span><br><span class="line">                var ua= navigator.userAgent.toLowerCase();</span><br><span class="line">                var ipad= ua.match(/ipad/i) == &quot;ipad&quot;;</span><br><span class="line">                var iphone= ua.match(/iphone os/i) == &quot;iphone os&quot;;</span><br><span class="line"></span><br><span class="line">                var mid= ua.match(/midp/i) == &quot;midp&quot;;</span><br><span class="line"></span><br><span class="line">//midp，即Mobile Internet Device pad，一种新的“比智能电话大，比笔记本小”的互联网终端。</span><br><span class="line"></span><br><span class="line">                var uc7= ua.match(/rv:1.2.3.4/i) == &quot;rv:1.2.3.4&quot;;</span><br><span class="line">                var uc= ua.match(/ucweb/i) == &quot;ucweb&quot;;</span><br><span class="line">                var android= ua.match(/android/i) == &quot;android&quot;;</span><br><span class="line">                var ce= ua.match(/windows ce/i) == &quot;windows ce&quot;;</span><br><span class="line">                var mobile= ua.match(/windows mobile/i) == &quot;windows mobile&quot;;</span><br><span class="line">                if (ipad|| iphone|| mid|| uc7|| uc || android|| ce|| mobile) &#123;</span><br><span class="line">                    //跳转移动端页面</span><br><span class="line">                    window.location.href=&quot;http://www.wanshaobo.com/mobile/index.html&quot;;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //跳转pc端页面</span><br><span class="line">                    window.location.href=&quot;http://www.wanshaobo.com/index.html&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></div></article></div></main><footer><div class="paginator"><a href="/2021/08/18/nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/" class="prev">上一篇</a><a href="/2021/08/09/HTTP%E5%8D%8F%E8%AE%AE%E4%B8%AD%E7%9A%84OPTIONS/" class="next">下一篇</a></div><div class="copyright"><p>© 2018 - 2021 <a href="https://www.doublekai.com">DOUBLEKAI</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>